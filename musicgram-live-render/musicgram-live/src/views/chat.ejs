<section class="card chat">
  <div class="row"><b>Chat</b></div>
  <div id="chatlog" class="chatlog"></div>
  <form id="composer" class="row" style="margin-top:8px">
    <input class="input" id="msg" placeholder="Mensagem...">
    <button class="btn">Enviar</button>
  </form>
</section>

<script src="/socket.io/socket.io.js"></script>
<script>
  const threadId = <%- JSON.stringify(threadId) %>;
  const socket = io({ path:'/socket.io' });
  const log = document.getElementById('chatlog');

  socket.on('connect', ()=> socket.emit('join', 'thread:'+threadId));

  socket.on('chat:newMessage', (m)=>{
    if(m.thread_id !== threadId) return;
    const div = document.createElement('div');
    const me = <%- JSON.stringify(user && user.id) %>;
    div.className = 'msg' + (m.from_user_id===me ? ' me' : '');
    div.textContent = m.body;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  });

  document.getElementById('composer').addEventListener('submit', (e)=>{
    e.preventDefault();
    const body = document.getElementById('msg').value.trim();
    if(!body) return;
    socket.emit('chat:send', { threadId, body });
    document.getElementById('msg').value='';
  });
</script>
