
<section class="card chat">
  <div style="display:flex;align-items:center;justify-content:space-between">
    <h3 style="margin:0">Chat</h3>
  </div>
  <div id="chatlog" class="chatlog"></div>
  <form id="composer" style="display:flex;gap:8px;margin-top:8px">
    <input class="input" id="msg" placeholder="Mensagem...">
    <button class="btn primary">Enviar</button>
  </form>
</section>

<script src="/socket.io/socket.io.js"></script>
<script>
  const threadId = <%- JSON.stringify(threadId) %>;
  const socket = io({ path:'/socket.io' });
  const log = document.getElementById('chatlog');
  const me = <%- JSON.stringify(user && user.id) %>;

  const add = (m) => {
    const div = document.createElement('div');
    div.className = 'bubble' + (m.from_user_id===me ? ' me' : '');
    div.textContent = m.body;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  };

  socket.on('connect', ()=> socket.emit('join', 'thread:'+threadId));
  socket.on('chat:newMessage', (m)=>{ if(m.thread_id===threadId) add(m); });

  document.getElementById('composer').addEventListener('submit', (e)=>{
    e.preventDefault();
    const body = document.getElementById('msg').value.trim();
    if(!body) return;
    socket.emit('chat:send', { threadId, body });
    document.getElementById('msg').value='';
  });
</script>
