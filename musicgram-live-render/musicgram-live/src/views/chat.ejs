
<section class="card chat">
  <h3 style="margin:10px">Chat</h3>
  <div id="chatlog" class="chatlog"></div>
  <form id="composer" style="display:flex;gap:8px;margin:10px">
    <input class="input" id="msg" placeholder="Mensagem...">
    <button class="btn primary">Enviar</button>
  </form>
</section>

<script src="/socket.io/socket.io.js"></script>
<script>
  const threadId = <%- JSON.stringify(threadId) %>;
  const me = <%- JSON.stringify(user && user.id) %>;
  const socket = io({ path:'/socket.io' });
  const log = document.getElementById('chatlog');
  const add = (m)=>{ const d=document.createElement('div'); d.className='bubble'+(m.from_user_id===me?' me':''); d.textContent=m.body; log.appendChild(d); log.scrollTop=log.scrollHeight; };
  socket.on('connect', ()=> socket.emit('join', 'thread:'+threadId));
  socket.on('chat:newMessage', (m)=>{ if(m.thread_id===threadId) add(m); });
  document.getElementById('composer').addEventListener('submit', (e)=>{
    e.preventDefault(); const body=document.getElementById('msg').value.trim(); if(!body) return;
    socket.emit('chat:send', { threadId, body }); document.getElementById('msg').value='';
  });
</script>
